{% extends "base.html" %}

{% block content %}
<div class="admin-container">
    <header class="admin-header">
        <h1>Hallintapaneeli</h1>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ sources|length }}</div>
            <div class="stat-label">Datal√§hteet</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ doc_count }}</div>
            <div class="stat-label">Asiakirjat</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ case_count }}</div>
            <div class="stat-label">Tapaukset</div>
        </div>
        <div class="stat-card stat-card-budget">
            <div class="stat-value">‚Ç¨{{ "%.2f"|format(llm_spend) }} / ‚Ç¨{{ "%.0f"|format(llm_budget) }}</div>
            <div class="stat-label">LLM-budjetti (t√§m√§ kuukausi)</div>
            <div class="budget-bar">
                <div class="budget-fill" style="width: {{ (llm_spend / llm_budget * 100) if llm_budget else 0 }}%">
                </div>
            </div>
        </div>
    </div>

    <section class="admin-section">
        <h2>üì° Datal√§hteet</h2>

        {% if sources %}
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Kunta</th>
                    <th>Alusta</th>
                    <th>Tila</th>
                    <th>Viimeisin onnistuminen</th>
                    <th>Virheet</th>
                </tr>
            </thead>
            <tbody>
                {% for source in sources %}
                <tr class="{% if source.consecutive_failures > 0 %}row-warning{% endif %}">
                    <td><strong>{{ source.municipality }}</strong></td>
                    <td><code>{{ source.platform }}</code></td>
                    <td>
                        {% if source.enabled %}
                        {% if source.consecutive_failures == 0 %}
                        <span class="status-badge status-ok">‚úì OK</span>
                        {% else %}
                        <span class="status-badge status-error">‚úó {{ source.consecutive_failures }} virhett√§</span>
                        {% endif %}
                        {% else %}
                        <span class="status-badge status-disabled">Pois k√§yt√∂st√§</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if source.last_success_at %}
                        {{ source.last_success_at.strftime('%d.%m.%Y %H:%M') }}
                        {% else %}
                        Ei koskaan
                        {% endif %}
                    </td>
                    <td class="error-cell">
                        {% if source.last_error %}
                        <span title="{{ source.last_error }}">{{ source.last_error[:50] }}...</span>
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <p>Ei datal√§hteit√§. Lis√§√§ l√§hde komennolla:</p>
            <code>python -m watchdog.cli add-source -m "Kunta" -p platform -u "https://..."</code>
        </div>
        {% endif %}
    </section>

    <section class="admin-section">
        <h2>üõ†Ô∏è Pikatoiminnot</h2>
        <div class="actions-grid">
            <div class="action-card">
                <h3>Aja putki</h3>
                <p>Hae, tunnista ja k√§sittele uudet asiakirjat</p>
                <code>python -m watchdog.cli run-pipeline</code>
            </div>
            <div class="action-card">
                <h3>Tarkista tila</h3>
                <p>N√§yt√§ datal√§hteiden tilanne</p>
                <code>python -m watchdog.cli health</code>
            </div>
            <div class="action-card">
                <h3>Lis√§√§ l√§hde</h3>
                <p>Lis√§√§ uusi kunta seurantaan</p>
                <code>python -m watchdog.cli add-source --help</code>
            </div>
        </div>
    </section>
</div>
{% endblock %}