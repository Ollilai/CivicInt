{% extends "base.html" %}

{% block content %}
<div class="dossier-container">
    <a href="/feed" class="back-link">‚Üê Takaisin tapauksiin</a>

    <header class="dossier-header">
        <div class="dossier-badges">
            <span class="case-category category-{{ case.primary_category }}">
                {% if case.primary_category == 'extraction' %}Maa-ainekset
                {% elif case.primary_category == 'zoning' %}Kaavoitus
                {% elif case.primary_category == 'energy' %}Energia
                {% elif case.primary_category == 'forestry' %}Mets√§talous
                {% elif case.primary_category == 'water' %}Vesist√∂t
                {% else %}{{ case.primary_category|replace('_', ' ')|title }}{% endif %}
            </span>
            <span class="case-status status-{{ case.status }}">
                {% if case.status == 'proposed' %}Vireill√§{% elif case.status == 'approved' %}Hyv√§ksytty{% elif
                case.status == 'appealed' %}Valitettu{% else %}{{ case.status|title }}{% endif %}
            </span>
            <span class="case-confidence">
                {% if case.confidence == 'high' %}Korkea{% elif case.confidence == 'medium' %}Keskitaso{% else
                %}Matala{% endif %} varmuus
            </span>
        </div>

        <h1 class="dossier-headline">{{ case.headline }}</h1>

        {% if case.municipalities_json %}
        <div class="case-location" style="display: inline-flex; margin-bottom: 1rem;">
            <span class="case-location-icon">üìç</span>
            <span>{{ case.municipalities_json|replace('[', '')|replace(']', '')|replace('"', '') }}</span>
        </div>
        {% endif %}

        {% if case.confidence_reason %}
        <p class="confidence-reason">{{ case.confidence_reason }}</p>
        {% endif %}
    </header>

    <section class="dossier-section">
        <h2>Keskeiset tiedot</h2>
        <div class="debrief-content">
            {# SECURITY: Do not use |safe on LLM-generated content - XSS risk #}
            {{ case.summary_md | e }}
        </div>
    </section>

    {% if case.events %}
    <section class="dossier-section">
        <h2>Aikajana</h2>
        <div class="timeline">
            {% for event in case.events %}
            <div class="timeline-item">
                <div class="timeline-date">
                    {% if event.event_time %}
                    {{ event.event_time.strftime('%d.%m.%Y') }}
                    {% else %}
                    P√§iv√§m√§√§r√§ tulossa
                    {% endif %}
                </div>
                <div class="timeline-content">
                    <span class="timeline-type">{{ event.event_type|replace('_', ' ')|title }}</span>
                    {% if event.payload_json %}
                    <p style="margin: 0.25rem 0 0; color: var(--color-text-secondary); font-size: 0.875rem;">
                        {{ event.payload_json|replace('{', '')|replace('}', '')|replace('"description":',
                        '')|replace('"', '') }}
                    </p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if case.evidence %}
    <section class="dossier-section">
        <h2>Todisteet</h2>
        <div class="evidence-list">
            {% for ev in case.evidence %}
            <div class="evidence-item">
                <div class="evidence-meta">
                    {% if ev.page %}<span>Sivu {{ ev.page }}</span>{% endif %}
                    {% if ev.source_url %}
                    <a href="{{ ev.source_url }}" target="_blank" rel="noopener" class="evidence-link">Avaa l√§hde ‚Üí</a>
                    {% endif %}
                </div>
                {% if ev.snippet %}
                <blockquote class="evidence-snippet">
                    {{ ev.snippet | e }}
                </blockquote>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if case.evidence %}
    <section class="dossier-section">
        <h2>L√§hdeasiakirjat</h2>
        <div class="sources-list">
            {% set seen_docs = [] %}
            {% for ev in case.evidence %}
            {% if ev.document and ev.document.id not in seen_docs %}
            {% set _ = seen_docs.append(ev.document.id) %}
            <a href="{{ ev.document.source_url or ev.source_url }}" target="_blank" rel="noopener" class="source-link">
                <span>üìÑ</span>
                <span>{{ ev.document.title }}</span>
            </a>
            {% endif %}
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="dossier-section">
        <h2>Omat muistiinpanot</h2>
        <form class="notes-form">
            <textarea id="note-input"
                placeholder="Lis√§√§ muistiinpanoja, havaintoja tai toimenpidelistaa t√§h√§n tapaukseen..."
                class="note-textarea"></textarea>
            <button type="submit" class="btn btn-primary">Tallenna</button>
        </form>
    </section>

    <div style="text-align: center; padding: 1rem 0; color: var(--color-text-muted); font-size: 0.8125rem;">
        P√§ivitetty viimeksi: {{ case.updated_at.strftime('%d.%m.%Y klo %H:%M') }}
    </div>
</div>
{% endblock %}