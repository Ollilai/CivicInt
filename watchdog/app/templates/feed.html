{% extends "base.html" %}

{% block content %}
<div class="feed-container">
    <header class="feed-header">
        <h1>Ymp√§rist√∂tapaukset</h1>
        <p class="feed-subtitle">Seurannassa {{ cases|length }} tapausta Lapin kunnista</p>
    </header>

    <div class="filters-bar">
        <div class="filter-group">
            {# Primary filter: Can I influence this? #}
            <label class="toggle-filter">
                <input type="checkbox" id="filter-actionable" checked>
                <span class="toggle-label">Vain avoimet kuulemiset</span>
            </label>

            {# Municipality filter #}
            <select id="filter-municipality" class="filter-select">
                <option value="">Kaikki kunnat</option>
                {% for municipality in municipalities %}
                <option value="{{ municipality }}">{{ municipality }}</option>
                {% endfor %}
            </select>

            {# Category filter #}
            <select id="filter-category" class="filter-select">
                <option value="">Kaikki aiheet</option>
                <option value="extraction">Maa-ainekset & Luvat</option>
                <option value="zoning">Kaavoitus & Maank√§ytt√∂</option>
                <option value="energy">Energia & Infrastruktuuri</option>
                <option value="forestry">Mets√§talous</option>
                <option value="water">Vesist√∂t & Kosteikot</option>
            </select>
        </div>

        <div class="search-box">
            <input type="text" id="search" placeholder="Hae..." class="search-input">
        </div>
    </div>

    <div class="cases-grid" id="cases-grid">
        {% if cases %}
        {% for case in cases %}
        <article class="case-card" data-category="{{ case.primary_category }}" data-status="{{ case.status }}"
            data-municipality="{{ case.municipalities_json|replace('[', '')|replace(']', '')|replace('\"', '') if case.municipalities_json else '' }}">

            {# Actionable badge - prominent at top #}
            {% if case.status == ' proposed' %} <div class="case-deadline-banner deadline-soon">
            <span>üó£Ô∏è Voit vaikuttaa</span>
    </div>
    {% endif %}

    <div class="case-card-body">
        <div class="case-header">
            <span class="case-category category-{{ case.primary_category }}">
                {% if case.primary_category == 'extraction' %}Maa-ainekset
                {% elif case.primary_category == 'zoning' %}Kaavoitus
                {% elif case.primary_category == 'energy' %}Energia
                {% elif case.primary_category == 'forestry' %}Mets√§talous
                {% elif case.primary_category == 'water' %}Vesist√∂t
                {% else %}{{ case.primary_category|replace('_', ' ')|title }}{% endif %}
            </span>
            {% if case.municipalities_json %}
            <span class="case-municipality">
                üìç {{ case.municipalities_json|replace('[', '')|replace(']', '')|replace('"', '') }}
            </span>
            {% endif %}
        </div>

        <h2 class="case-headline">{{ case.headline }}</h2>

        <div class="case-summary">
            {# SECURITY: Do not use |safe on LLM-generated content - XSS risk #}
            {{ case.summary_md | e }}
        </div>

        <div class="case-meta">
            <span class="case-status status-{{ case.status }}">
                {% if case.status == 'proposed' %}üü¢ Vireill√§{% elif case.status == 'approved' %}‚úì P√§√§tetty{% else %}{{
                case.status|title }}{% endif %}
            </span>
            <span class="case-time">{{ case.updated_at.strftime('%d.%m.%Y') }}</span>
        </div>

        <div class="case-actions">
            <a href="/case/{{ case.id }}" class="btn btn-primary">Avaa</a>
            <button class="btn btn-icon btn-star" title="Tallenna seurantaan" aria-label="Tallenna">‚òÜ</button>
        </div>
    </div>
    </article>
    {% endfor %}
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">üå≤</div>
        <h2>Ei tapauksia viel√§</h2>
        <p>Vahtikoira on valmis seuraamaan kuntien ymp√§rist√∂p√§√§t√∂ksi√§.</p>
        <code>python -m watchdog.cli run-pipeline --stage all</code>
    </div>
    {% endif %}
</div>
</div>
{% endblock %}